"use server";

import { getServerSession } from "next-auth";
import { authOptions } from "@app/api/auth/[...nextauth]/route";
import { PrismaClient } from "@prisma/client";
import { revalidatePath } from "next/cache";
async function updateCollection(data) {
  try {
    const prisma = new PrismaClient();
    const session = await getServerSession(authOptions);
    const uid = session?.user.id;
    const { cid, photos, collectionName } = data;

    const res = await prisma.$transaction(async (prisma) => {
      let collectionData = collectionName ? { name: collectionName } : {};

      if (photos) {
        // Insert photos
        const newPhotos = await prisma.photo.createMany(
          {
            data: photos.map((photo) => ({
              name: photo.name,
              cid,
              uid,
              aperture: parseFloat(photo.aperture),
              shutterspeed: photo.shutterspeed,
              iso: parseInt(photo.iso),
              pid: photo.fileId, // generated by b2
            })),
          },

          { timeout: 10000 }
        );

        if (!newPhotos || newPhotos.count === 0) {
          return { status: 400, message: "Unable to create photos" };
        }

        // Update thumbnail
        const thumbnail = await prisma.photo.findFirst({
          where: {
            cid,
            uid,
          },
        });

        if (!thumbnail) {
          return { status: 404, message: "Thumbnail not found" };
        }

        collectionData = {
          ...collectionData,
          thumbnail: {
            connect: {
              pid: thumbnail.pid,
            },
          },
        };
      }

      const updatedCollection = await prisma.collection.update({
        where: { cid_uid: { cid, uid } },
        data: collectionData,
        include: {
          photos: true,
        },
      });
      if (!updatedCollection) {
        return { status: 400, message: "Unable to update collection " };
      }
      return { status: 200, message: "Success", data: updatedCollection };
    });

    revalidatePath("/");
    return res;
  } catch (err) {
    console.log(err);
    return { status: 500 };
  }
}

export default updateCollection;
